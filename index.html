<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kala Residency UPI Payment</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: system-ui, Roboto, sans-serif; background: linear-gradient(135deg,#667eea 0,#764ba2 100%); padding:20px; display:flex; justify-content:center; align-items:center; min-height:100vh; color:#222; }
    .container { width:100%; max-width:540px; background:#fff; padding:28px; border-radius:18px; box-shadow:0 20px 50px rgba(0,0,0,0.25); position:relative; }
    .header { text-align:center; margin-bottom:20px; }
    .logo { width:72px; height:72px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:28px; background:linear-gradient(135deg,#667eea,#764ba2); box-shadow:0 6px 18px rgba(102,126,234,0.35); margin-bottom:10px; }
    h2 { margin-bottom:4px; font-size:20px; }
    .subtitle { color:#666; font-size:13px; }
    form .form-group { margin-bottom:16px; }
    label { display:block; font-weight:600; margin-bottom:6px; font-size:14px; }
    select,input { width:100%; padding:12px 14px; border-radius:10px; border:1px solid #e6e6e6; background:#fafafa; font-size:14px; }
    button.primary { width:100%; padding:12px; border-radius:10px; border:none; background:linear-gradient(135deg,#667eea,#764ba2); color:white; font-weight:700; cursor:pointer; }
    .success { display:none; padding:12px; border-radius:10px; background:linear-gradient(135deg,#11998e,#38ef7d); color:#fff; margin-bottom:12px; text-align:center; font-weight:700; }
    #qrSection { display:none; margin-top:20px; }
    
    /* New QR Format Styling */
    .qr-container { 
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      text-align: center;
    }
    .qr-header {
      background-color: #007bff;
      color: white;
      padding: 15px;
      margin: -16px -16px 20px -16px;
    }
    .qr-header h3 {
      margin: 0;
      font-size: 1.5em;
    }
    .qr-header p {
      font-size: 0.8em;
      margin: 5px 0 0 0;
    }
    .payment-details {
      text-align: left;
      margin-bottom: 20px;
      border: 1px solid #00aaff;
      padding: 15px;
      border-radius: 4px;
      background-color: #e6f7ff;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      font-size: 0.9em;
    }
    .detail-label {
      font-weight: bold;
      color: #333;
    }
    .detail-value {
      color: #00aaff;
      font-weight: bold;
    }
    #qrImage {
      display: block;
      margin: 0 auto;
      border: 2px solid #ccc;
      padding: 10px;
      background-color: #fff;
      max-width: 100%;
      height: auto;
    }
    .instruction {
      background-color: #ffc107;
      color: #333;
      padding: 10px;
      border-radius: 4px;
      font-size: 0.8em;
      margin-top: 20px;
      font-weight: bold;
    }
    .footer-note {
      font-size: 0.7em;
      margin-top: 20px;
      color: #666;
      text-align: center;
    }
    
    .actions { display:flex; gap:10px; margin-top:12px; }
    .btn { flex:1; padding:10px; border-radius:10px; border:none; font-weight:700; cursor:pointer; }
    .btn.green { background:linear-gradient(135deg,#11998e,#38ef7d); color:#fff; }
    .note { background:#fff8e6; border-left:6px solid #ff9800; padding:12px; margin-top:12px; border-radius:8px; font-size:13px; line-height:1.4; color:#333; }
    .note b { color:#e65100; }
    .small { font-size:13px; color:#666; margin-top:8px; }
    .row { display:flex; gap:8px; }
    @media (max-width:520px){ .container{padding:18px;} #qrImage{width:220px;height:220px;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">KR</div>
      <h2>Kala Residency</h2>
      <div class="subtitle">Secure Online Payment System</div>
    </div>

    <div id="successMessage" class="success">✓ Payment details saved! QR generated.</div>

    <form id="payForm">
      <div class="form-group">
        <label>Flat/Shop Number</label>
        <select id="flat" required>
          <option value="">Select your flat/shop</option>
        </select>
      </div>

      <div class="form-group">
        <label>Full Name</label>
        <input id="userName" type="text" placeholder="Enter your name" required />
      </div>

      <div class="form-group">
        <label>Payment Month</label>
        <input id="month" type="month" required />
      </div>

      <div class="form-group">
        <label>Amount (₹)</label>
        <input id="amount" type="number" min="1" placeholder="Enter amount" required />
      </div>

      <div class="form-group">
        <label>Payment Purpose</label>
        <select id="purpose" required>
          <option>Maintenance</option>
          <option>Water Charges</option>
          <option>Parking</option>
          <option>Sinking Fund</option>
          <option>Other</option>
        </select>
      </div>

      <div style="display:flex; gap:8px; margin-bottom:10px;">
        <button id="generateBtn" class="primary" type="submit">Generate Payment QR Code</button>
      </div>
    </form>

    <div id="qrSection">
      <div class="qr-container">
        <div class="qr-header">
          <h3>Kala Residency</h3>
          <p>Secure & Verified Online Payment System</p>
        </div>

        <img id="qrImage" alt="Payment QR Code" src="" width="250" height="250">
        
        <div class="payment-details">
          <h3 style="text-align: center; color: #00aaff; margin-top: 0;">Payment Details</h3>
          <div class="detail-row"><span class="detail-label">Flat No / Shop</span> <span class="detail-value" id="qrFlat">-</span></div>
          <div class="detail-row"><span class="detail-label">Name</span> <span class="detail-value" id="qrName">-</span></div>
          <div class="detail-row"><span class="detail-label">Amount</span> <span class="detail-value" id="qrAmount">-</span></div>
          <div class="detail-row"><span class="detail-label">Purpose</span> <span class="detail-value" id="qrPurpose">-</span></div>
          <div class="detail-row"><span class="detail-label">Month</span> <span class="detail-value" id="qrMonth">-</span></div>
          <div class="detail-row"><span class="detail-label">Payment ID</span> <span class="detail-value" id="qrPaymentId">-</span></div>
        </div>

        <div class="actions">
          <button id="downloadQR" class="btn green">⬇ Download QR</button>
        </div>

        <div class="instruction">
          Use this QR only Once - Delete from Mobile Gallery after use to avoid wrong entries at next payment
        </div>

        <p class="footer-note">Generated by Kala Residency Online Payment System</p>
      </div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
/* Updated Google Apps Script web app URL */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNbPl0VKx9wEBujlBcyWlJ8k7aNERxkA9twEfuGkZt4SQYGU9PpWuTchpKgljiURBw/exec";

/* UPI PAY DETAILS (change PA & PN as needed) */
const UPI_PA = "9766893279@kotak811";
const UPI_PN = "DEVENDRA KAPOORE";
const UPI_CU = "INR";
/* ============================================ */

/* Fallback owner map (from your provided list) */
const fallbackOwners = {
  "Flat 1": "BAGUL",
  "Flat 2": "GAYDHANI",
  "Flat 3": "GAIKWAD",
  "Flat 4": "MEHENDALE",
  "Flat 5": "GAIKWAD",
  "Flat 6": "DABHADE",
  "Flat 7": "Khandgune",
  "Flat 8": "S SHARMA",
  "Flat 9": "BANCHHODE",
  "Flat 10": "KARCHE",
  "Flat 11": "SAPKAL",
  "Flat 12": "DUGDHE",
  "Flat 13": "ZOPE",
  "Flat 14": "WAGHMARE",
  "Flat 15": "JOGI",
  "Flat 16": "BHAVSAR",
  "Flat 17": "B PATIL",
  "Flat 18": "V PATIL",
  "Flat 19": "KAPOORE",
  "Flat 20": "SHARMA",
  "Flat 21": "KHANDARE",
  "Shop 1": "SHOP 1",
  "Shop 2": "SHOP 2",
  "Shop 3": "SHOP 3",
  "Shop 4": "SHOP 4",
  "Shop 5": "SHOP 5"
};

/* ---------- Populate Flat Select ---------- */
const flatSelect = document.getElementById('flat');
Object.keys(fallbackOwners).forEach(k => {
  const opt = document.createElement('option'); opt.value = k; opt.textContent = k; flatSelect.appendChild(opt);
});

/* Try fetch owners from server (will override fallback if available) */
async function loadOwnersFromServer() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getOwners`);
    const json = await res.json();
    if (json.status === 'ok' && json.owners) {
      // Clear existing and populate from server
      flatSelect.innerHTML = '<option value="">Select your flat/shop</option>';
      Object.keys(json.owners).forEach(k => {
        const opt = document.createElement('option'); opt.value = k; opt.textContent = k; flatSelect.appendChild(opt);
      });
      // merge owners data for fallback access
      Object.assign(fallbackOwners, json.owners);
    }
  } catch (e) {
    console.log("Owners fetch failed, using fallback owners.", e);
  }
}
loadOwnersFromServer();

/* Set current month */
document.getElementById('month').value = new Date().toISOString().slice(0,7);

/* Auto-fill name when flat selected */
flatSelect.addEventListener('change', (e) => {
  const flat = e.target.value;
  const nameInput = document.getElementById('userName');
  if (flat && fallbackOwners[flat]) {
    nameInput.value = fallbackOwners[flat];
  } else {
    // leave empty
    nameInput.value = '';
  }
});

/* Format name capitalization */
function capWords(s) {
  return s.split(' ').map(w => w ? (w[0].toUpperCase()+w.slice(1).toLowerCase()) : '').join(' ');
}

/* Generate UPI link */
function buildUpiLink({amount, note}) {
  return `upi://pay?pa=${encodeURIComponent(UPI_PA)}&pn=${encodeURIComponent(UPI_PN)}&am=${encodeURIComponent(amount)}&cu=${encodeURIComponent(UPI_CU)}&tn=${encodeURIComponent(note)}`;
}

/* Duplicate check */
async function checkDuplicate(flat, month) {
  try {
    const url = `${SCRIPT_URL}?action=checkDuplicate&flat=${encodeURIComponent(flat)}&month=${encodeURIComponent(month)}`;
    const res = await fetch(url);
    const json = await res.json();
    if (json.status === 'ok') return json.exists;
    return false;
  } catch (e) {
    console.log('Duplicate check failed:', e);
    // if server fails, allow submission (or you could block)
    return false;
  }
}

/* Enhanced framed QR generator - with reduced width (400px) */
async function generateFramedQRDataURL(upi, data) {
  // canvas layout: header + content area + footer
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  // Reduced width from 600px to 400px
  const width = 400;
  const height = 600; // Adjusted height to maintain aspect ratio
  canvas.width = width;
  canvas.height = height;

  // background
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,width,height);

  // header
  const headerH = 80;
  ctx.fillStyle = "#007bff";
  ctx.fillRect(0,0,width,headerH);

  // Title
  ctx.fillStyle = "#ffffff"; 
  ctx.font = "bold 18px Arial"; 
  ctx.textAlign = "center"; 
  ctx.fillText("Kala Residency", width/2, 30);
  
  ctx.font = "12px Arial"; 
  ctx.textAlign = "center"; 
  ctx.fillText("Secure & Verified Online Payment System", width/2, 50);

  // Load QR image
  const img = new Image();
  img.crossOrigin = "Anonymous";
  img.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upi)}`;
  await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; });

  // Draw QR
  const qrSize = 180;
  const qrX = (width - qrSize) / 2;
  const qrY = headerH + 30;
  ctx.drawImage(img, qrX, qrY, qrSize, qrSize);

  // Payment details box
  const detailsY = qrY + qrSize + 20;
  const detailsH = 150;
  
  // Box background
  ctx.fillStyle = "#e6f7ff";
  ctx.fillRect(30, detailsY, width - 60, detailsH);
  
  // Box border
  ctx.strokeStyle = "#00aaff";
  ctx.lineWidth = 2;
  ctx.strokeRect(30, detailsY, width - 60, detailsH);
  
  // Details Title
  ctx.fillStyle = "#00aaff"; 
  ctx.font = "bold 16px Arial"; 
  ctx.textAlign = "center"; 
  ctx.fillText("Payment Details", width/2, detailsY + 20);

  // Details lines
  ctx.textAlign = "left"; 
  ctx.font = "bold 12px Arial"; 
  
  const dx = 45;
  let dy = detailsY + 40;
  const lineGap = 18;

  ctx.fillStyle = "#333"; ctx.fillText("Flat No / Shop:", dx, dy); 
  ctx.fillStyle = "#00aaff"; ctx.fillText(data.flat || '-', dx + 120, dy); 
  dy += lineGap;
  
  ctx.fillStyle = "#333"; ctx.fillText("Name:", dx, dy); 
  ctx.fillStyle = "#00aaff"; ctx.fillText(data.name || '-', dx + 120, dy); 
  dy += lineGap;
  
  ctx.fillStyle = "#333"; ctx.fillText("Amount:", dx, dy); 
  ctx.fillStyle = "#00aaff"; ctx.fillText(`₹${data.amount}`, dx + 120, dy); 
  dy += lineGap;
  
  ctx.fillStyle = "#333"; ctx.fillText("Purpose:", dx, dy); 
  ctx.fillStyle = "#00aaff"; ctx.fillText(data.purpose || '-', dx + 120, dy); 
  dy += lineGap;
  
  ctx.fillStyle = "#333"; ctx.fillText("Month:", dx, dy); 
  ctx.fillStyle = "#00aaff"; ctx.fillText(data.month || '-', dx + 120, dy); 
  dy += lineGap;
  
  ctx.fillStyle = "#333"; ctx.fillText("Payment ID:", dx, dy); 
  ctx.fillStyle = "#00aaff"; ctx.fillText(data.paymentId || '-', dx + 120, dy);

  // Warning box bottom
  const warningY = detailsY + detailsH + 20;
  ctx.fillStyle = "#ffc107"; 
  ctx.fillRect(30, warningY, width - 60, 50);
  
  ctx.strokeStyle = "#ff9800"; 
  ctx.lineWidth = 2; 
  ctx.strokeRect(30, warningY, width - 60, 50);
  
  ctx.fillStyle = "#333"; 
  ctx.font = "bold 10px Arial"; 
  ctx.textAlign = "center"; 
  ctx.fillText("Use this QR only Once - Delete after use", width/2, warningY + 20);
  ctx.fillText("to avoid wrong entries", width/2, warningY + 35);

  // Footer small text
  ctx.fillStyle = "#666"; 
  ctx.font = "9px Arial"; 
  ctx.textAlign = "center"; 
  ctx.fillText("Generated by Kala Residency Online Payment System", width/2, height - 15);

  return canvas.toDataURL("image/jpeg", 0.95);
}

/* ---- Handlers ---- */
document.getElementById('payForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  // collect
  const flat = document.getElementById('flat').value.trim();
  let name = document.getElementById('userName').value.trim();
  name = capWords(name);
  document.getElementById('userName').value = name;
  const month = document.getElementById('month').value;
  const amount = document.getElementById('amount').value;
  const purpose = document.getElementById('purpose').value;

  if (!flat || !name || !month || !amount) {
    alert("Please fill all required fields.");
    return;
  }

  // Duplicate check
  const exists = await checkDuplicate(flat, month);
  if (exists) {
    alert(`Payment for ${flat} for month ${month} already exists. If this is a correction, please contact secretary.`);
    return;
  }

  // Show details
  document.getElementById('qrFlat').textContent = flat;
  document.getElementById('qrName').textContent = name;
  document.getElementById('qrAmount').textContent = "₹" + amount;
  document.getElementById('qrMonth').textContent = month;
  document.getElementById('qrPurpose').textContent = purpose;
  
  // Generate payment ID
  const paymentId = `KRP${Date.now().toString().slice(-6)}`;
  document.getElementById('qrPaymentId').textContent = paymentId;

  // Build upi note and link
  const note = `${flat} - ${name} - ${month} - ${purpose}`;
  const upi = buildUpiLink({ amount, note });

  // Set image preview (from QR API) so user sees it quickly
  document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(upi)}`;

  // Show section
  document.getElementById('qrSection').style.display = "block";
  document.getElementById('successMessage').style.display = "block";

  // Scroll
  document.getElementById('qrSection').scrollIntoView({ behavior: 'smooth' });

  // Save to Google Sheet (post)
  try {
    const payload = { flat, name, month, amount, purpose, remark: '', paymentId };
    await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify(payload)
    });
  } catch (err) {
    console.log("Save to sheet failed (non-blocking):", err);
  }
});

/* Download framed QR */
document.getElementById('downloadQR').addEventListener('click', async () => {
  const flat = document.getElementById('qrFlat').textContent;
  const name = document.getElementById('qrName').textContent;
  const amount = document.getElementById('qrAmount').textContent.replace('₹','') || '0';
  const month = document.getElementById('qrMonth').textContent;
  const purpose = document.getElementById('qrPurpose').textContent;
  const paymentId = document.getElementById('qrPaymentId').textContent;
  
  if (!flat) return alert('Please generate the QR first.');

  const note = `${flat} - ${name} - ${month} - ${purpose}`;
  const upi = buildUpiLink({ amount, note });
  const data = { flat, name, amount, month, purpose, paymentId };

  try {
    const framed = await generateFramedQRDataURL(upi, data);
    const a = document.createElement('a');
    a.href = framed;
    a.download = `Kala_Residency_QR_${flat}_${month}.jpg`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  } catch (e) {
    console.error('Framed QR generation failed', e);
    alert('QR download failed, try again.');
  }
});
</script>
</body>
</html>
